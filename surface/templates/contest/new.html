

{% extends 'include/base.html' %}
{% block title %}新建比赛{% endblock %}


{% block body %}
    <div class="container">
        <div class="row clearfix">
            <div class="col-md-2 column"></div>
            <div class="col-md-8 column mt-2">
                <div class="card">
                    <div class="card-header">
                        新建比赛
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="form-group row">
                                <label for="id_title" class="col-lg-3 col-form-label">标题</label>
                                <div class="col-lg-9">
                                    <input type="text" class="form-control" id="id_title" required>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="id_start_time" class="col-lg-3 col-form-label">开始时间</label>
                                <div class="col-lg-6">
                                    <input id="id_start_time" type="datetime-local" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="id_end_time" class="col-lg-3 col-form-label">结束时间</label>
                                <div class="col-lg-6">
                                    <input id="id_end_time" type="datetime-local" class="form-control">
                                </div>
                                <div class="col-lg-3">

                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-lg-2">
                                    <input id="id_add_pid" type="button" class="form-control btn btn-secondary"
                                           value="添加题目">
                                    <script>

                                        function handleSupport(res) {
                                            let remotes = "";
                                            res.data.forEach(function (oj_name) {
                                                remotes += "<option value=\"" + oj_name + "\">" + oj_name + "</option>";
                                            });
                                            localStorage.setItem('supports', remotes);
                                            return remotes;
                                        }

                                        function getRemotes() {
                                            if (localStorage.getItem('supports') === null || localStorage.getItem('set_supports_times') === null || moment().subtract(1, 'hours').isAfter(localStorage.getItem('set_supports_times'))) {
                                                getSupport(handleSupport);
                                                localStorage.setItem('set_supports_times', moment().format());
                                            }
                                            return localStorage.getItem('supports');

                                        }

                                        function getRemoteItem() {
                                            return "                                <div  class=\"form-row id_pid_item\">\n" +
                                                "                                    <div class=\"form-group col-md-3\">\n" +
                                                "                                        <select class=\"class_supports form-control class_oid\">\n" +
                                                getRemotes() +
                                                "                                        </select>\n" +
                                                "\n" +
                                                "                                    </div>\n" +
                                                "                                    <div class=\"form-group col-md-2\">\n" +
                                                "                                        <input type=\"text\" class=\"form-control class_pid\" placeholder=\"源编号\">\n" +
                                                "                                    </div>\n" +
                                                "                                    <div class=\"form-group col-md-4\">\n" +
                                                "                                        <input type=\"text\" class=\"form-control class_alias\" placeholder=\"重命名\">\n" +
                                                "                                    </div>\n" +
                                                "                                    <div class=\"form-group col-md-3\">\n" +
                                                "                                        <span class=\"badge class_link\"></span>\n" +
                                                "                                    </div>\n" +
                                                "                                </div>\n";
                                        }


                                        function handlePidChange() {
                                            let this_tr = $(this).parent().parent();
                                            getProblem(this_tr.find('.class_oid').val(), this_tr.find('.class_pid').val(), this_tr.find('.class_link'), handleProblemSearch);
                                        }

                                        $('#id_add_pid').click(function () {
                                            if ($("#id_pid_list").children().length < 30) {
                                                $("#id_pid_list").append(getRemoteItem());
                                                if (localStorage.getItem('select_oj')) {
                                                    $("#id_pid_list").children(":last-child").find('.class_oid').val(localStorage.getItem('select_oj'));
                                                }
                                                //$('.class_pid').unbind('blur');
                                                // $('.class_pid').bind('blur', handlePidChange);
                                                $(document).on('change', '.class_oid', handleSelectChange);
                                                $("#id_delete_pid").disabled = false
                                            } else {
                                                $(this).disabled = true
                                            }
                                        });

                                        function handleSelectChange() {
                                            localStorage.setItem("select_oj", $(this).val());
                                        }
                                    </script>
                                </div>
                                <div class="form-group col-lg-2">
                                    <input id="id_delete_pid" type="button" class="form-control btn btn-danger"
                                           value="删除">
                                    <script>
                                        $("#id_delete_pid").click(function () {
                                            if ($("#id_pid_list").children().length > 0) {
                                                $("#id_pid_list").children("div:last-child").remove();
                                                $("#id_add_pid").disabled = false
                                            } else {
                                                $(this).disabled = true
                                            }
                                        })
                                    </script>
                                </div>

                            </div>
                            <div id="id_pid_list" class="form-group">

                            </div>
                            <div class="form-row justify-content-center">
                                <button id="id_button" type="button" class="col-lg-2 form-control btn btn-primary">
                                    提交
                                </button>
                            </div>
                            <script>
                                $(document).ready(function () {
                                    $("#id_start_time").val(moment().format("YYYY-MM-DDTLT"));
                                    $("#id_start_time").attr('time_offset', moment().format("Z"));
                                    $("#id_end_time").val(moment().add(5, 'h').format("YYYY-MM-DDTLT"));
                                    $("#id_end_time").attr('time_offset', moment().format("Z"));
                                });
                                $("#id_button").click(function () {
                                    $("#id_pid_list").children().each(function (i,item) {
                                        console.log(item.children());
                                        console.log(i);
                                    });
                                })
                            </script>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-2 column"></div>
        </div>
    </div>
{% endblock %}